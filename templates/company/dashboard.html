{% extends "base.html" %}

{% block title %}Company Dashboard - JobVibe AI{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="py-5" style="background: rgba(99, 102, 241, 0.1); border-bottom: 1px solid rgba(99, 102, 241, 0.2);">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-white fw-bold mb-1">üè¢ {{ company.company_name }}</h1>
                <p class="text-muted mb-0">Manage your job postings and candidates</p>
            </div>
            <a href="{{ url_for('company.create_job') }}" class="btn btn-primary">
                ‚ûï Post New Job
            </a>
        </div>
    </div>
</div>

<div class="container py-5">
    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="glass-card h-100">
                <div class="p-4">
                    <div class="d-flex align-items-center">
                        <div class="d-flex align-items-center justify-content-center rounded-3 me-3" 
                             style="width: 50px; height: 50px; background: rgba(99, 102, 241, 0.2);">
                            <span style="font-size: 1.5rem;">üíº</span>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Active Jobs</h6>
                            <h3 class="mb-0 fw-bold gradient-text">{{ active_jobs }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card h-100">
                <div class="p-4">
                    <div class="d-flex align-items-center">
                        <div class="d-flex align-items-center justify-content-center rounded-3 me-3" 
                             style="width: 50px; height: 50px; background: rgba(16, 185, 129, 0.2);">
                            <span style="font-size: 1.5rem;">üìÑ</span>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Total Applications</h6>
                            <h3 class="mb-0 fw-bold" style="color: #10b981;">{{ total_applications }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card h-100">
                <div class="p-4">
                    <div class="d-flex align-items-center">
                        <div class="d-flex align-items-center justify-content-center rounded-3 me-3" 
                             style="width: 50px; height: 50px; background: rgba(245, 158, 11, 0.2);">
                            <span style="font-size: 1.5rem;">‚≠ê</span>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Shortlisted</h6>
                            <h3 class="mb-0 fw-bold" style="color: #f59e0b;">{{ shortlisted }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card h-100">
                <div class="p-4">
                    <div class="d-flex align-items-center">
                        <div class="d-flex align-items-center justify-content-center rounded-3 me-3" 
                             style="width: 50px; height: 50px; background: rgba(6, 182, 212, 0.2);">
                            <span style="font-size: 1.5rem;">üìä</span>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Total Jobs</h6>
                            <h3 class="mb-0 fw-bold" style="color: #06b6d4;">{{ total_jobs }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Applications -->
    <form id="dashboardBulkForm" method="POST" action="{{ url_for('company.dashboard_bulk_interview') }}">
        <!-- Bulk Action Bar (Hidden by default) -->
        <div class="glass-card mb-3" id="dashboardBulkActionBar" style="display: none;">
            <div class="p-3 d-flex align-items-center justify-content-between"
                style="background: rgba(16, 185, 129, 0.15); border-radius: 12px;">
                <div class="d-flex align-items-center">
                    <span class="me-3 text-white">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        <strong id="dashboardSelectedCount">0</strong> candidates selected
                    </span>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success" id="sendInterviewBtn">
                        <i class="bi bi-send me-2"></i>Send Interview ID
                    </button>
                    <button type="button" class="btn btn-outline-light" onclick="clearDashboardSelection()">
                        Clear Selection
                    </button>
                </div>
            </div>
        </div>

        <div class="glass-card">
            <div class="p-4 border-bottom" style="border-color: rgba(255, 255, 255, 0.1) !important;">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-semibold text-white">
                        <span class="me-2">üïê</span>Recent Applications
                    </h5>
                    <a href="{{ url_for('company.jobs') }}" class="btn btn-sm btn-outline-light">
                        View All Jobs
                    </a>
                </div>
            </div>
            <div class="p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4" style="width: 50px;">
                                    <input type="checkbox" class="form-check-input" id="dashboardSelectAll"
                                        onchange="toggleDashboardSelectAll()" title="Select All">
                                </th>
                                <th>Candidate</th>
                                <th>Job Position</th>
                                <th>AI Score</th>
                                <th>Status</th>
                                <th>Interview</th>
                                <th>Applied</th>
                                <th class="pe-4">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for app in recent_applications %}
                            <tr>
                                <td class="ps-4">
                                    {% if not app.interview and app.status not in ['Rejected', 'Hired'] %}
                                    <input type="checkbox" class="form-check-input dashboard-candidate-checkbox"
                                        name="selected_applications" value="{{ app.app_id }}"
                                        data-job-id="{{ app.job_id }}"
                                        onchange="updateDashboardSelection()">
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="d-flex align-items-center justify-content-center rounded-circle me-2" 
                                             style="width: 40px; height: 40px; background: rgba(99, 102, 241, 0.2); color: #a5b4fc; font-weight: 600;">
                                            {{ app.candidate.full_name[0] }}
                                        </div>
                                        <div>
                                            <strong class="text-white">{{ app.candidate.full_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ app.candidate.user.email }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-muted">{{ app.job.title }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="width: 60px; height: 8px; border-radius: 4px; background: rgba(255,255,255,0.1);">
                                            <div class="progress-bar" style="width: {{ app.ai_resume_score }}%; background: {% if app.ai_resume_score >= 70 %}#10b981{% elif app.ai_resume_score >= 50 %}#f59e0b{% else %}#ef4444{% endif %};"></div>
                                        </div>
                                        <span class="badge" style="background: {% if app.ai_resume_score >= 70 %}rgba(16, 185, 129, 0.2); color: #10b981;{% elif app.ai_resume_score >= 50 %}rgba(245, 158, 11, 0.2); color: #f59e0b;{% else %}rgba(239, 68, 68, 0.2); color: #ef4444;{% endif %}">
                                            {{ app.ai_resume_score|round(1) }}%
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge" style="background: {% if app.status == 'Applied' %}rgba(99, 102, 241, 0.2); color: #a5b4fc;{% elif app.status == 'Screening' %}rgba(6, 182, 212, 0.2); color: #06b6d4;{% elif app.status == 'Shortlisted' %}rgba(16, 185, 129, 0.2); color: #10b981;{% elif app.status == 'Interview' %}rgba(245, 158, 11, 0.2); color: #f59e0b;{% elif app.status == 'Rejected' %}rgba(239, 68, 68, 0.2); color: #ef4444;{% else %}rgba(16, 185, 129, 0.2); color: #10b981;{% endif %}">
                                        {{ app.status }}
                                    </span>
                                </td>
                                <td>
                                    {% if app.interview %}
                                        {% if app.interview.is_completed %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>Done
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-clock me-1"></i>Pending
                                        </span>
                                        <br>
                                        <small class="text-info">{{ app.interview.interview_code }}</small>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ app.applied_at.strftime('%b %d, %Y') }}</small>
                                </td>
                                <td class="pe-4">
                                    <a href="{{ url_for('company.company_view_application', app_id=app.app_id) }}" 
                                       class="btn btn-sm btn-outline-light">
                                        View
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div style="font-size: 3rem;">üì≠</div>
                                    <p class="text-muted mt-2 mb-0">No applications yet</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    function toggleDashboardSelectAll() {
        const selectAll = document.getElementById('dashboardSelectAll');
        const checkboxes = document.querySelectorAll('.dashboard-candidate-checkbox');
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateDashboardSelection();
    }

    function updateDashboardSelection() {
        const checkboxes = document.querySelectorAll('.dashboard-candidate-checkbox:checked');
        const count = checkboxes.length;
        const actionBar = document.getElementById('dashboardBulkActionBar');
        const countSpan = document.getElementById('dashboardSelectedCount');

        countSpan.textContent = count;
        actionBar.style.display = count > 0 ? 'block' : 'none';
    }

    function clearDashboardSelection() {
        document.getElementById('dashboardSelectAll').checked = false;
        document.querySelectorAll('.dashboard-candidate-checkbox').forEach(cb => cb.checked = false);
        updateDashboardSelection();
    }

    // Form submission with loading state
    document.getElementById('dashboardBulkForm').addEventListener('submit', function(e) {
        const btn = document.getElementById('sendInterviewBtn');
        const checkboxes = document.querySelectorAll('.dashboard-candidate-checkbox:checked');
        
        if (checkboxes.length === 0) {
            e.preventDefault();
            alert('Please select at least one candidate.');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating Questions...';
    });
</script>
{% endblock %}
